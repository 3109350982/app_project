<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ–éŸ³è‡ªåŠ¨åŒ–ç³»ç»Ÿ</title>
    <style>
        .control-panel { min-height: 0; max-height: 100%; overflow-y: auto; }
        .data-panel    { min-height: 0; max-height: 100%; overflow-y: auto; }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        
        /* å·¦ä¾§æ“ä½œé¢æ¿ */
        .control-panel {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .header h1 {
            color: #1a1a1a;
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 0.9em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1890ff;
        }
        
        .stat-number {
            font-size: 1.4em;
            font-weight: bold;
            color: #1890ff;
            display: block;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .function-section {
            margin-bottom: 20px;
            padding: 18px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1890ff;
            transition: all 0.3s ease;
        }
        
        .function-section:hover {
            background: #f0f7ff;
        }
        
        .function-section h3 {
            color: #1a1a1a;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-group {
            margin-bottom: 12px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: 500;
            font-size: 0.85em;
        }
        
        .control-group input, .control-group textarea, .control-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s ease;
            background: #ffffff;
        }
        
        .control-group input:focus, .control-group textarea:focus, .control-group select:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }
        
        .control-group textarea {
            height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
        }
        
        .btn-success {
            background: #52c41a;
            color: white;
        }
        
        .btn-success:hover {
            background: #73d13d;
        }
        
        .btn-warning {
            background: #faad14;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #ffc53d;
        }
        
        .btn-danger {
            background: #ff4d4f;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff7875;
        }
        
        .btn-secondary {
            background: #8c8c8c;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #a6a6a6;
        }
        
        .btn:disabled {
            background: #d9d9d9;
            color: #8c8c8c;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-running {
            background: #52c41a;
            animation: pulse 2s infinite;
        }
        
        .status-stopped {
            background: #ff4d4f;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* å³ä¾§æ•°æ®é¢æ¿ */
        .data-panel {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .data-header {
            padding: 20px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-header h2 {
            color: #1a1a1a;
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .bulk-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .selection-info {
            color: #666;
            font-size: 0.9em;
            margin-right: 10px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e8e8e8;
            background: #fafafa;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
            font-size: 0.9em;
        }
        
        .tab:hover {
            color: #1890ff;
            background: #f0f7ff;
        }
        
        .tab.active {
            border-bottom-color: #1890ff;
            color: #1890ff;
            font-weight: 600;
            background: #ffffff;
        }
        
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .data-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .data-toolbar {
            padding: 15px 20px;
            border-bottom: 1px solid #e8e8e8;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toolbar-left, .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .data-content {
            flex: 1;
            overflow: auto;
            padding: 0;
        }
        
        .log-container {
            height: 100%;
            overflow-y: auto;
            background: #1f1f1f;
            color: #e0e0e0;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 6px;
            padding: 6px 10px;
            border-left: 3px solid transparent;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .log-entry.error {
            border-left-color: #ff4d4f;
            color: #ff7875;
            background: rgba(255, 77, 79, 0.1);
        }
        
        .log-entry.warning {
            border-left-color: #faad14;
            color: #ffc53d;
            background: rgba(250, 173, 20, 0.1);
        }
        
        .log-entry.success {
            border-left-color: #52c41a;
            color: #73d13d;
            background: rgba(82, 196, 26, 0.1);
        }
        
        .log-entry.info {
            border-left-color: #1890ff;
            color: #69c0ff;
            background: rgba(24, 144, 255, 0.1);
        }
        
        .users-list, .videos-list {
            padding: 0;
        }
        
        .user-item, .video-item {
            padding: 15px;
            margin: 0;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .user-item:hover, .video-item:hover {
            background: #f8f9fa;
        }
        
        .user-item.selected, .video-item.selected {
            background: #f0f7ff;
            border-left: 4px solid #1890ff;
        }
        
        .checkbox-container {
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .item-content {
            flex: 1;
            min-width: 0;
        }
        
        .user-header, .video-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .user-name, .video-title {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 1em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-meta, .video-meta {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            gap: 10px;
        }
        
        .user-comment, .video-desc {
            color: #555;
            margin: 8px 0;
            line-height: 1.4;
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 4px;
            border-left: 2px solid #e0e0e0;
            font-size: 0.85em;
        }


        .status-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .status-pending {
            background: #fff7e6;
            color: #d46b08;
            border: 1px solid #ffd591;
        }
        
        .status-sent {
            background: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 14px;
            border-radius: 16px;
            font-size: 0.8em;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .connected {
            background: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
        }
        
        .disconnected {
            background: #fff2f0;
            color: #cf1322;
            border: 1px solid #ffccc7;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8c8c8c;
        }
        
        .empty-state .icon {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: #8c8c8c;
            margin-bottom: 6px;
            font-size: 1.1em;
        }
        
        .empty-state p {
            font-size: 0.9em;
        }
        
        /* é€‰æ¡†æ ·å¼ */
        #marquee {
            position: fixed;
            border: 2px solid #1890ff;
            background: rgba(24, 144, 255, 0.1);
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 500px;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #1a1a1a;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .modal-body {
            margin-bottom: 24px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group select, .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .confirmation-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .confirmation-input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }
        
        /* ç´§å‡‘å¸ƒå±€è°ƒæ•´ */
        .compact-control {
            margin-bottom: 8px;
        }
        
        .advanced-toggle {
            color: #1890ff;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .advanced-content {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e8e8e8;
        }
        
        .advanced-content.show {
            display: block;
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .control-panel {
                max-height: 50vh;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .data-toolbar {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .toolbar-left, .toolbar-right {
                justify-content: center;
            }
        }
        .virtual-list {
            position: relative;
            overflow-y: auto;
            height: 100%;
        }

        .virtual-list-inner {
            position: relative;
            width: 100%;
        }

        .virtual-row {
            position: absolute;
            left: 0;
            width: 100%;
        }


    </style>
</head>
<body>
    <!-- è¿æ¥çŠ¶æ€ -->
    <div id="connectionStatus" class="connection-status disconnected">
        ğŸ”´ æœªè¿æ¥
    </div>
    
    <!-- é€‰æ¡†å…ƒç´  -->
    <div id="marquee"></div>
    
    <!-- æ¸…é™¤æ•°æ®æ¨¡æ€æ¡† -->
    <div id="clearDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ¸…é™¤ç±»å‹:</label>
                    <select id="clearDataType">
                        <option value="videos">è§†é¢‘æ•°æ®</option>
                        <option value="users">ç”¨æˆ·æ•°æ®</option>
                        <option value="task_logs">ä»»åŠ¡æ—¥å¿—</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ¸…é™¤èŒƒå›´:</label>
                    <select id="clearDataScope">
                        <option value="all">å…¨éƒ¨æ•°æ®</option>
                        <option value="selected">ä»…é€‰ä¸­é¡¹</option>
                        <option value="unsent">ä»…æœªå‘é€ç”¨æˆ·</option>
                        <option value="sent">ä»…å·²å‘é€ç”¨æˆ·</option>
                        <option value="days">åˆ é™¤Nå¤©åŠå…¶ä»¥å‰çš„çš„æ•°æ®</option>
                    </select>
                </div>
                <div class="form-group" id="daysInputContainer" style="display: none;">
                    <label>å¤©æ•°:</label>
                    <input type="number" id="clearDataDays" value="7" min="1" max="365">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤æ“ä½œ (è¾“å…¥ DELETE ç¡®è®¤):</label>
                    <input type="text" id="clearDataConfirm" class="confirmation-input" placeholder="è¾“å…¥ DELETE">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelClearBtn">å–æ¶ˆ</button>
                <button class="btn btn-danger" id="confirmClearBtn" disabled>ç¡®è®¤æ¸…é™¤</button>
            </div>
        </div>
    </div>
    <div id="licenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>ğŸ” è®¸å¯è¯éªŒè¯</h3></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>è®¸å¯è¯å¯†é’¥</label>
                    <input id="licenseKeyInput" type="text" placeholder="VIP-2025-0001">
                    <div id="licenseInfo" style="margin-top:6px;color:#666;"></div>
                </div>
                <div id="licenseErr" style="color:#cf1322;display:none;margin-top:6px;">æ¿€æ´»å¤±è´¥</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="licenseQuitBtn">é€€å‡º</button>
                <button class="btn btn-primary" id="licenseOkBtn">éªŒè¯å¹¶ç»§ç»­</button>
            </div>
        </div>
    </div>

    <!-- å…è´£å£°æ˜æ¨¡æ€æ¡† -->
    <div id="disclaimerModal" class="modal" style="display:none">
        

        <div class="modal-content" style="max-width:760px;max-height:80vh;display:flex;flex-direction:column">
            <div class="modal-header">
                <h3>ğŸ“„ ä½¿ç”¨å…è´£å£°æ˜</h3>
            </div>
            <div class="modal-body" style="overflow:auto">
                <ol style="margin:0;padding-left:20px;line-height:1.6">
                    <li>æœ¬è½¯ä»¶ä»…æä¾›æ•°æ®æ”¶é›†ä»¥æ­¤æ¥å­¦ä¹ çš„è¾…åŠ©èƒ½åŠ›ï¼Œ<b>ä¸å¾—</b>ç”¨äºè¿åã€Šä¸­åäººæ°‘å…±å’Œå›½ç½‘ç»œå®‰å…¨æ³•ã€‹ã€Šäº’è”ç½‘ä¿¡æ¯æœåŠ¡ç®¡ç†åŠæ³•ã€‹åŠæŠ–éŸ³å¹³å°ç”¨æˆ·åè®®ã€ç¤¾åŒºå…¬çº¦çš„ä»»ä½•è¡Œä¸ºï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šåƒåœ¾ä¿¡æ¯ç¾¤å‘ã€æ¶æ„è¥é”€ã€è¯ˆéª—ã€éªšæ‰°ã€ä¾µçŠ¯éšç§ã€è™šå‡æˆ–è¯¯å¯¼æ€§å†…å®¹ä¼ æ’­ã€å¼•æµæ¬ºè¯ˆã€ç»•è¿‡æˆ–å‰Šå¼±å¹³å°é£æ§/åæ»¥ç”¨æœºåˆ¶ã€å¯¹å¹³å°æ¥å£æˆ–æ•°æ®è¿›è¡Œæœªç»æˆæƒçš„æŠ“å–ä¸å†åˆ†å‘ç­‰ã€‚</li>
                    <li>ç”¨æˆ·é¡»è‡ªè¡Œç¡®ä¿å…¶æ“ä½œå…·å¤‡åˆæ³•ã€åˆè§„ã€æ­£å½“çš„æˆæƒä¸ç›®çš„ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå¯¹è”ç³»äºº/æ”¶ä»¶äººå–å¾—å……åˆ†å‘ŠçŸ¥ä¸åŒæ„ã€éµå®ˆé¢‘ç‡ä¸é…é¢é™åˆ¶ï¼Œä¸å¾—å®æ–½è‡ªåŠ¨åŒ–æ‰¹é‡éªšæ‰°æˆ–å…¶ä»–ä¾µæƒè¡Œä¸ºã€‚</li>
                    <li>ç”¨æˆ·å¯¹ä½¿ç”¨æœ¬è½¯ä»¶çš„ä¸€åˆ‡è¡Œä¸ºåŠåæœæ‰¿æ‹…å…¨éƒ¨è´£ä»»ã€‚è‹¥å› è¿è§„ä½¿ç”¨å¯¼è‡´æŠ–éŸ³è´¦å·é™åˆ¶/å°ç¦ã€æ³•å¾‹è¡Œæ”¿å¤„ç½šã€æ°‘äº‹çº çº·æˆ–ç¬¬ä¸‰æ–¹ç´¢èµ”ï¼Œè½¯ä»¶å¼€å‘è€…ä¸æ‰¿æ‹…ä»»ä½•ç›´æ¥ã€é—´æ¥ã€é™„å¸¦æˆ–è¿å¸¦è´£ä»»ã€‚</li>
                    <li>æœ¬è½¯ä»¶æŒ‰â€œç°çŠ¶â€æä¾›ï¼Œä¸å¯¹è·å®¢æ•ˆæœã€è½¬åŒ–æ”¶ç›Šã€å¯ç”¨æ€§ã€ç¨³å®šæ€§ä½œä»»ä½•æ˜ç¤ºæˆ–é»˜ç¤ºä¿è¯ã€‚ç”±æ­¤äº§ç”Ÿçš„ä»»ä½•æŸå¤±æˆ–é£é™©ï¼ˆå«å•†ä¸šã€æ•°æ®ã€å£°èª‰ç­‰ï¼‰ç”±ç”¨æˆ·è‡ªè¡Œæ‰¿æ‹…ã€‚</li>
                    <li>æœ¬è½¯ä»¶ä¸ä¸»åŠ¨é‡‡é›†ä¸å¤„ç†è¶…å‡ºåŠŸèƒ½å¿…è¦èŒƒå›´çš„ä¸ªäººä¿¡æ¯ã€‚æˆæƒå¯†é’¥ä¸è¿è¡Œæ—¥å¿—ä»…ç”¨äºæœ¬åœ°æ ¡éªŒä¸æ’éšœã€‚ç”¨æˆ·å¦‚å°†æ—¥å¿—/æ•°æ®ä¸Šä¼ è‡³ç¬¬ä¸‰æ–¹å­˜å‚¨æˆ–åˆ†æå¹³å°ï¼Œåº”è‡ªè¡Œéµå®ˆç›¸åº”åˆè§„è¦æ±‚ã€‚</li>
                    <li>å¦‚å¼€å‘è€…å‘ç°ç”¨æˆ·å­˜åœ¨è¿è§„æˆ–å¼‚å¸¸é£é™©ï¼Œæœ‰æƒåœ¨ä¸å¦è¡Œé€šçŸ¥çš„æƒ…å†µä¸‹æš‚åœæˆ–ç»ˆæ­¢å…¶ä½¿ç”¨æƒé™ï¼ˆå«åŠé”€å¯†é’¥ï¼‰ã€‚</li>
                    <li>æœ¬å£°æ˜å¯èƒ½æ ¹æ®æ³•å¾‹æ³•è§„åŠå¹³å°è§„åˆ™æ›´æ–°è€Œè°ƒæ•´ï¼Œæ›´æ–°åå°†å³æ—¶ç”Ÿæ•ˆã€‚ç»§ç»­ä½¿ç”¨å³è§†ä¸ºæ¥å—æœ€æ–°å£°æ˜ã€‚</li>
                    <li>é€‚ç”¨æ³•å¾‹ä¸äº‰è®®è§£å†³ï¼šæœ¬å£°æ˜çš„è®¢ç«‹ã€æ•ˆåŠ›ã€è§£é‡Šã€å±¥è¡ŒåŠäº‰è®®è§£å†³é€‚ç”¨ä¸­åäººæ°‘å…±å’Œå›½æ³•å¾‹ã€‚å› æœ¬å£°æ˜å¼•å‘çš„æˆ–ä¸ä¹‹æœ‰å…³çš„äº‰è®®ï¼Œç”±å¼€å‘è€…æ‰€åœ¨åœ°äººæ°‘æ³•é™¢ç®¡è¾–ã€‚</li>
                    <li>ç”¨æˆ·ä¸‹è½½ã€å®‰è£…æˆ–ä½¿ç”¨æœ¬è½¯ä»¶å³è¡¨ç¤ºå·²å……åˆ†é˜…è¯»ã€ç†è§£å¹¶åŒæ„ä»¥ä¸Šå…¨éƒ¨å†…å®¹ï¼›å¦‚ä¸åŒæ„ï¼Œè¯·ç«‹å³åœæ­¢ä½¿ç”¨å¹¶åˆ é™¤è½¯ä»¶ã€‚</li>
                    
                </ol>
            </div>
            <div class="modal-footer" style="gap:8px">
                <button class="btn btn-secondary" id="disclaimerQuitBtn">é€€å‡ºç¨‹åº</button>
                <button class="btn btn-primary" id="disclaimerAckBtn">æˆ‘å·²çŸ¥æ™“</button>
            </div>
        </div>
    </div>
    <!-- æ‰‹åŠ¨æ·»åŠ è§†é¢‘æ¨¡æ€æ¡† -->
    <div id="addVideoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• æ‰‹åŠ¨æ·»åŠ è§†é¢‘</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>è§†é¢‘é“¾æ¥ï¼ˆå¿…å¡«ï¼‰</label>
                    <input id="manualVideoUrl" type="text" placeholder="https://www.douyin.com/video/xxxx">
                </div>

                <div class="form-group">
                    <label>è§†é¢‘æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="manualVideoDesc" type="text" placeholder="è§†é¢‘æ ‡é¢˜">
                </div>

                <div class="form-group">
                    <label>å…³é”®è¯ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="manualVideoKeyword" type="text" placeholder="å¦‚ï¼šåˆ‡å°”è¥¿ åŠ çº³">
                </div>

                <div class="form-group">
                    <label>ä½œè€…æ˜µç§°ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="manualVideoAuthor" type="text">
                </div>

                <div class="form-group">
                    <label>ç‚¹èµæ•°ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="manualVideoLike" type="number" value="0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeAddVideoModalBtn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmAddVideoBtn">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- å·¦ä¾§æ“ä½œé¢æ¿ -->
        <div class="control-panel">
            <div class="header">
                <h1>ğŸ¯ æŠ–éŸ³è‡ªåŠ¨åŒ–ç³»ç»Ÿ</h1>
                <p class="subtitle">æ™ºèƒ½è·å®¢ä¸è¥é”€è‡ªåŠ¨åŒ–</p>
            </div>
            
            <!-- ç³»ç»ŸçŠ¶æ€ç»Ÿè®¡ -->
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number" id="totalUsers">0</span>
                    <span class="stat-label">æ€»ç”¨æˆ·</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="pendingUsers">0</span>
                    <span class="stat-label">å¾…å‘é€</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="sentUsers">0</span>
                    <span class="stat-label">å·²å‘é€</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="todayUsers">0</span>
                    <span class="stat-label">ä»Šæ—¥æ–°å¢</span>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿæ§åˆ¶ -->
            <div class="function-section">
                <h3>ğŸš€ ç³»ç»Ÿæ§åˆ¶</h3>
                <div class="button-group">
                    <button class="btn btn-primary" id="startBrowserBtn">
                        ğŸ–¥ï¸ å¯åŠ¨æµè§ˆå™¨
                    </button>
                    <button class="btn btn-danger" id="stopAllServicesBtn">
                        ğŸ›‘ åœæ­¢æ‰€æœ‰
                    </button>
                </div>
            </div>
            
            <!-- éšæœºç‚¹èµ -->
            <div class="function-section">
                <h3>
                    ğŸ‘ éšæœºç‚¹èµ
                    <span class="status-indicator status-stopped" id="likeStatusIndicator"></span>
                </h3>
                <div class="control-group compact-control">
                    <label>è¿è¡Œæ—¶é—´ (åˆ†é’Ÿ):</label>
                    <input type="number" id="likeDuration" value="10" min="1" max="1200">
                </div>
                <div class="control-group compact-control">
                <label>ç‚¹èµé¢‘ç‡ (%):</label>
                <input type="number" id="likeFrequency" value="60" min="0" max="100">
                </div>
                <div class="button-group">
                    <button class="btn btn-success" id="startLikeBtn">
                        ğŸš€ å¼€å§‹
                    </button>
                    <button class="btn btn-danger" id="stopLikeBtn">
                        ğŸ›‘ åœæ­¢
                    </button>
                </div>
            </div>
            
            <!-- é˜¶æ®µä¸€ï¼šè§†é¢‘é‡‡é›† -->
            <div class="function-section">
                <h3>
                    ğŸ“¹ é˜¶æ®µä¸€ï¼šè§†é¢‘é‡‡é›†
                    <span class="status-indicator status-stopped" id="stage1StatusIndicator"></span>
                </h3>
                <div class="control-group compact-control">
                    <label>å†…å®¹å…³é”®è¯:</label>
                    <input type="text" id="contentKeywords" placeholder="äº§å“ æœåŠ¡ å’¨è¯¢">
                </div>
                <div class="control-group compact-control">
                    <label>é‡‡é›†ç•Œé¢:</label>
                    <select id="sortType">
                        <option value="è§†é¢‘">è§†é¢‘</option>
                        <option value="ç»¼åˆ">ç»¼åˆ</option>
                    </select>
                </div>
                <div class="advanced-toggle" onclick="toggleAdvanced('stage1Advanced')">
                    âš™ï¸ é«˜çº§é€‰é¡¹
                </div>
                <div class="advanced-content" id="stage1Advanced">
                    <div class="control-group compact-control">
                        <label>æ¯ä¸ªå…³é”®è¯è§†é¢‘æ•°(æ•°é‡ä¼šæœ‰ä¸Šä¸‹æµ®åŠ¨):</label>
                        <input type="number" id="videosPerKeyword" value="5" min="1" max="65536">
                    </div>
                    <div class="control-group compact-control">
                        <label>è¿è¡Œæ—¶é—´ (åˆ†é’Ÿ):</label>
                        <input type="number" id="stage1Duration" value="10" min="1" max="1200">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" id="startStage1Btn">
                        ğŸš€ å¼€å§‹é‡‡é›†
                    </button>
                    <button class="btn btn-danger" id="stopStage1Btn">
                        ğŸ›‘ åœæ­¢
                    </button>
                </div>
            </div>
            
            <!-- é˜¶æ®µäºŒï¼šç”¨æˆ·é‡‡é›† -->
            <div class="function-section">
                <h3>
                    ğŸ‘¥ é˜¶æ®µäºŒï¼šç”¨æˆ·é‡‡é›†
                    <span class="status-indicator status-stopped" id="stage2StatusIndicator"></span>
                </h3>
                <div class="control-group compact-control">
                    <label>ç”¨æˆ·è¯„è®ºå…³é”®è¯:</label>
                    <input type="text" id="userCommentKeywords" placeholder="å’¨è¯¢ äº†è§£ è´­ä¹°">
                </div>
                <div class="advanced-toggle" onclick="toggleAdvanced('stage2Advanced')">
                    âš™ï¸ é«˜çº§é€‰é¡¹
                </div>
                <div class="advanced-content" id="stage2Advanced">
                    <div class="control-group compact-control">
                        <label>IPå½’å±åœ°å…³é”®è¯:</label>
                        <input type="text" id="ipKeywords" placeholder="åŒ—äº¬ ä¸Šæµ· å¹¿å·">
                    </div>
                    <div class="control-group compact-control">
                        <label>è¿è¡Œæ—¶é—´ (åˆ†é’Ÿ):</label>
                        <input type="number" id="stage2Duration" value="10" min="1" max="1200">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" id="startStage2Btn">
                        ğŸš€ å¼€å§‹é‡‡é›†
                    </button>
                    <button class="btn btn-danger" id="stopStage2Btn">
                        ğŸ›‘ åœæ­¢
                    </button>
                </div>
            </div>
            
            <!-- ç§ä¿¡åŠŸèƒ½ -->
            <div class="function-section">
                <h3>
                    ğŸ’Œ ç§ä¿¡åŠŸèƒ½
                    <span class="status-indicator status-stopped" id="messageStatusIndicator"></span>
                </h3>
                <div class="control-group compact-control">
                    <label>ç§ä¿¡æ¨¡æ¿:</label>
                    <textarea id="messageTemplate">æ‚¨å¥½ï¼Œçœ‹åˆ°æ‚¨çš„è¯„è®ºï¼Œå¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼</textarea>
                </div>
                <div class="advanced-toggle" onclick="toggleAdvanced('messageAdvanced')">
                    âš™ï¸ é«˜çº§é€‰é¡¹
                </div>
                <div class="advanced-content" id="messageAdvanced">
                    <div class="control-group compact-control">
                        <label>è¿è¡Œæ—¶é—´ (åˆ†é’Ÿ):</label>
                        <input type="number" id="messageDuration" value="10" min="1" max="1200">
                    </div>
                    <div class="control-group compact-control">
                        <label>æ¯äººé—´éš” (åˆ†é’Ÿ):</label>
                        <input type="number" id="messageInterval" value="4" min="1" max="60">
                    </div>
                    <div class="control-group compact-control">
                        <label>
                            <input type="checkbox" id="rotateAccounts">
                            å¤šè´¦å·è½®è¯¢ï¼ˆAâ†’Bâ†’Câ€¦ ä¸å†ç­‰å¾…ï¼‰
                        </label>
                    </div>
                    <div class="control-group compact-control">
                        <label>è´¦å·æ ¹ç›®å½•:</label>
                        <input id="accountsRoot" type="text" placeholder="ä¾‹å¦‚ï¼šD:\DouyinProfiles æˆ– /Users/me/DouyinProfiles">
                    </div>

                    <div class="button-group" style="margin-top:6px">
                        <button class="btn btn-secondary" id="scanAccountsBtn">ğŸ“‚ ä»æ ¹ç›®å½•æ‰«æå­æ–‡ä»¶å¤¹</button>
                        <button class="btn btn-secondary" id="loadAccountsBtn">ğŸ“¥ è¯»å–å·²ä¿å­˜</button>
                        <button class="btn btn-warning"   id="saveAccountsBtn">ğŸ’¾ ä¿å­˜å½“å‰åˆ—è¡¨</button>

                        <button class="btn btn-success" id="createAndLoginBtn">â• æ–°å»ºå¹¶æ‰«ç å¹¶ä¿å­˜</button>
                    </div>

                    <div class="control-group compact-control" id="accountDirsBox" style="display:none">
                        <label>è´¦å·æ•°æ®ç›®å½•ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰:</label>
                        <textarea id="accountDirs" placeholder="ä¾‹å¦‚ï¼š
                            C:\DouyinProfiles\accA
                            C:\DouyinProfiles\accB
                            C:\DouyinProfiles\accC">
                        </textarea>
                    </div>


                </div>
                <div class="button-group">
                    <button class="btn btn-success" id="startMessageBtn">
                        ğŸš€ å¼€å§‹å‘é€
                    </button>
                    <button class="btn btn-danger" id="stopMessageBtn">
                        ğŸ›‘ åœæ­¢
                    </button>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§æ•°æ®é¢æ¿ -->
        <div class="data-panel">
            <div class="data-header">
                <h2>ğŸ“Š æ•°æ®ç›‘æ§</h2>
                <div class="bulk-actions">
                    <button class="btn btn-danger" id="clearDataBtn">
                        ç‚¹æˆ‘å¹¶è¾“å…¥DELETE
                            æ¸…é™¤æ•°æ®
                    </button>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('logs',this)">ğŸ“ ç³»ç»Ÿæ—¥å¿—</div>
                <div class="tab" onclick="switchTab('videos',this)">ğŸ“¹ è§†é¢‘åˆ—è¡¨</div>
                <div class="tab" onclick="switchTab('users',this)">ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</div>
            </div>
            
            <div class="data-container">
                <!-- ç³»ç»Ÿæ—¥å¿— -->
                <div id="logsTab" class="tab-content active">
                    <div class="data-toolbar">
                        <div class="toolbar-left">
                            <button class="btn btn-secondary" id="clearLogsBtn">æ¸…ç©ºæ—¥å¿—</button>
                        </div>
                    </div>
                    <div class="data-content">
                        <div class="log-container" id="logContainer">
                            <div class="log-entry info">ç­‰å¾…ç³»ç»Ÿè¿æ¥...</div>
                        </div>
                    </div>
                </div>
                
                <!-- è§†é¢‘åˆ—è¡¨ -->
                <div id="videosTab" class="tab-content">
                    <div class="data-toolbar">
                        <div class="toolbar-left">
                            <span class="selection-info" id="videosSelectionInfo">å·²é€‰ 0 é¡¹</span>
                            <button class="btn btn-secondary" id="selectAllVideosBtn">å…¨é€‰è§†é¢‘</button>
                            <button class="btn btn-secondary" id="clearVideosSelectionBtn">æ¸…ç©ºé€‰æ‹©</button>
                            <button class="btn btn-primary" id="stage2WithSelectedBtn">
                                ğŸ§² ç”¨é€‰ä¸­è§†é¢‘é‡‡é›†ç”¨æˆ·
                            </button>
                            <button class="btn btn-success" id="openAddVideoModalBtn">
                                â• æ‰‹åŠ¨æ·»åŠ è§†é¢‘
                            </button>
                            <!-- å…ˆä¸è¦è¿™ä¸ªåŠŸèƒ½å§ -->
                            <!-- <button class="btn btn-secondary" id="enrichSelectedVideosBtn">
                                ğŸ” è·å–é€‰ä¸­è§†é¢‘è¯¦ç»†æ•°æ®
                            </button> -->
                        </div>
                        <div class="toolbar-right">
                            <select id="videoSort" style="padding:6px 10px;border:1px solid #e8e8e8;border-radius:6px;margin-right:8px;">
                                <option value="time">æŒ‰é‡‡é›†æ—¶é—´</option>
                                <option value="publish">æŒ‰å‘å¸ƒæ—¶é—´</option>
                                <option value="like">æŒ‰ç‚¹èµæ•°</option>

                            </select>
                           <button class="btn btn-secondary" id="refreshVideosBtn">åˆ·æ–°</button>
                        </div>
                    </div> 
                    <div class="data-content">
                        <div class="videos-list" id="videosList">
                            <div class="empty-state">
                                <div class="icon">ğŸ“¹</div>
                                <h3>æš‚æ— è§†é¢‘æ•°æ®</h3>
                                <p>è¯·å…ˆè¿è¡Œé˜¶æ®µä¸€è§†é¢‘é‡‡é›†åŠŸèƒ½</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç”¨æˆ·åˆ—è¡¨ -->
                <div id="usersTab" class="tab-content">
                    <div class="data-toolbar">
                        <div class="toolbar-left">
                            <span class="selection-info" id="usersSelectionInfo">å·²é€‰ 0 é¡¹</span>
                            <button class="btn btn-secondary" id="selectAllUsersBtn">å…¨é€‰ç”¨æˆ·</button>
                            <button class="btn btn-secondary" id="clearUsersSelectionBtn">æ¸…ç©ºé€‰æ‹©</button>
                            <button class="btn btn-primary" id="sendToSelectedBtn">
                                ğŸ’Œ å¯¹é€‰ä¸­ç”¨æˆ·å‘ç§ä¿¡
                            </button>
                        </div>
                        <div class="toolbar-right">
                            <select id="userSort" style="padding:6px 10px;border:1px solid #e8e8e8;border-radius:6px;margin-right:8px;">
                                <option value="time">æŒ‰é‡‡é›†æ—¶é—´</option>
                                <option value="publish">æŒ‰è¯„è®ºå‘å¸ƒæ—¶é—´</option>
                                <option value="ip">æŒ‰ipå½’å±åœ°</option>
                            </select>
                            <button class="btn btn-secondary" id="refreshUsersBtn">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div class="data-content">
                        <div class="users-list" id="usersList">
                            <div class="empty-state">
                                <div class="icon">ğŸ‘¥</div>
                                <h3>æš‚æ— ç”¨æˆ·æ•°æ®</h3>
                                <p>è¯·å…ˆè¿è¡Œé˜¶æ®µäºŒç”¨æˆ·é‡‡é›†åŠŸèƒ½</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let ws = null;
        let reconnectInterval = null;
        let selectedVideos = new Set();
        let selectedUsers = new Set();
        let lastClickedIndex = -1;
        let isMarqueeSelecting = false;
        let marqueeStart = { x: 0, y: 0 };
        let marqueeEnd = { x: 0, y: 0 };
        let isShiftPressed = false;
        let isAltPressed = false;
        
        // æœåŠ¡çŠ¶æ€
        let likeRunning = false;
        let stage1Running = false;
        let stage2Running = false;
        let messageRunning = false;
        let browserRunning = false;
        let __appStarted = false;
        // åˆå§‹åŒ–

        function showLic(){ const m=document.getElementById('licenseModal'); if(m) m.style.display='flex'; }
        function hideLic(){ const m=document.getElementById('licenseModal'); if(m) m.style.display='none'; }
        function showDisclaimer(){ 
            const m=document.getElementById('disclaimerModal'); 
            if(m) m.style.display='flex'; 
            if (typeof lockAllMainButtons==='function') lockAllMainButtons(true);
        }
        function hideDisclaimer(){ 
            const m=document.getElementById('disclaimerModal'); 
            if(m) m.style.display='none'; 
            if (typeof lockAllMainButtons==='function') lockAllMainButtons(false);
        }

        // â€”â€” å…è´£å£°æ˜æŒ‰é’®ç»‘å®š â€”â€” 
        function bindDisclaimerUI(){
            const ack=document.getElementById('disclaimerAckBtn');
            const quit=document.getElementById('disclaimerQuitBtn');
            if (ack) ack.onclick = () => {
                try{ localStorage.setItem('disclaimerAck','true'); }catch(_){}
                hideDisclaimer();
                if (!__appStarted) { __appStarted = true; initializeApp(); }
            };
            if (quit) quit.onclick = () => { try{ fetch('/api/app/quit',{method:'POST'}) }catch(e){} window.close(); };
        }        

        async function showLicenseModalAlways(){
            let okBtn = document.getElementById('licenseOkBtn');
            let info  = document.getElementById('licenseInfo');
            let input = document.getElementById('licenseKeyInput');

            try{
                const r = await fetch('/api/license/status');
                const j = await r.json();
                const d = (j && j.data) ? j.data : {};

                // é¢„å¡«ä¸Šæ¬¡ key
                if (d.key) input.value = d.key;

                // ä¼˜å…ˆä½¿ç”¨ lic_expï¼ˆçœŸå®åˆ°æœŸï¼‰ï¼Œæ²¡æœ‰åˆ™å›é€€ token_exp/exp
                const licExp = Number(d.lic_exp || d.license_exp || 0);
                const tokExp = Number(d.token_exp || d.exp || 0);
                const nowSec = Math.floor(Date.now() / 1000);

                // åªåœ¨â€œæœªè¿‡æœŸâ€æ—¶æ˜¾ç¤º +1hï¼›å·²è¿‡æœŸåˆ™æ˜¾ç¤ºçœŸå®åˆ°æœŸ
                const licExpired = (licExp > 0 && nowSec >= licExp);
                const tsSec = licExp > 0
                ? (licExpired ? licExp : (licExp + 3600))
                : (tokExp > 0 ? tokExp : 0);

                const tsTxt  = tsSec ? (new Date(tsSec * 1000).toLocaleString()) : '';
                const expired = (d.expired === true) ||
                                (licExp > 0 && nowSec >= licExp) ||
                                (licExp <= 0 && tokExp > 0 && nowSec >= tokExp);
                if (expired) {
                    info.textContent = tsTxt ? ('å·²åˆ°æœŸï¼Œè¿‡æœŸæ—¶é—´ï¼š' + tsTxt) : 'å·²åˆ°æœŸ';
                    okBtn.textContent = 'éªŒè¯å¹¶ç»§ç»­';
                    okBtn.onclick = doActivate;
                } else if (d.valid === true) {
                    info.textContent = tsTxt ? ('å·²æˆæƒï¼Œè¿‡æœŸæ—¶é—´ï¼š' + tsTxt) : 'å·²æˆæƒ';
                    okBtn.textContent = 'ç»§ç»­ä½¿ç”¨';
                    if (!localStorage.getItem('disclaimerAck')) {
                        okBtn.onclick = () => { hideLic(); bindDisclaimerUI(); showDisclaimer(); };
                    }
                } else {
                    info.textContent = 'æœªæˆæƒæˆ–ä¼šè¯å·²å¤±æ•ˆï¼Œè¯·è¾“å…¥å¯†é’¥åéªŒè¯';
                    okBtn.textContent = 'éªŒè¯å¹¶ç»§ç»­';
                    okBtn.onclick = doActivate;
                }
            } catch(e){
                info.textContent = 'æ— æ³•è·å–æˆæƒçŠ¶æ€ï¼Œè¯·è¾“å…¥å¯†é’¥åéªŒè¯';
                okBtn.textContent = 'éªŒè¯å¹¶ç»§ç»­';
                okBtn.onclick = doActivate;
            }
            showLic();
        }
        async function doActivate(){
            const key = (document.getElementById('licenseKeyInput').value||'').trim();
            const err = document.getElementById('licenseErr');
            err.style.display='none';
            if(!key){ err.textContent='è¯·è¾“å…¥å¯†é’¥'; err.style.display='block'; return; }

            try{
                const r = await fetch('/api/license/activate?key='+encodeURIComponent(key), {method:'POST'});
                const j = await r.json();
                if (j.status==='success'){
                    // æˆåŠŸï¼šéšè—æˆæƒæ¡† -> å¼¹ç”¨æˆ·é¡»çŸ¥ï¼ˆé¦–æ¬¡æ¿€æ´»ä¹Ÿä¼šå¼¹ï¼‰
                    hideLic();
                    bindDisclaimerUI();
                    showDisclaimer();
                }else{
                    // å¤±è´¥ï¼šæç¤ºå¹¶ç«‹åˆ»é€€å‡ºåç«¯ + å…³é—­å‰ç«¯çª—å£
                    err.textContent='æ¿€æ´»å¤±è´¥ï¼š'+(j.message||'');
                    err.style.display='block';
                    try{ await fetch('/api/app/quit', {method:'POST'}) }catch(e){}
                    window.close();
                }
            }catch(e){
                err.textContent='æ¿€æ´»å¤±è´¥ï¼š'+e.message;
                err.style.display='block';
                try{ await fetch('/api/app/quit', {method:'POST'}) }catch(_){}
                window.close();
            }
        }


        // â€”â€” é¡µé¢åŠ è½½ï¼šæ€»æ˜¯å¼¹æˆæƒçª—ï¼ˆé€šè¿‡/ç»§ç»­ä½¿ç”¨å â†’ å…è´£å£°æ˜ â†’ æˆ‘å·²çŸ¥æ™“ â†’ initializeAppï¼‰ â€”â€”
        document.addEventListener('DOMContentLoaded', async function() {
            bindLicenseUI();
            await showLicenseModalAlways();
        });

        // â¬‡ é¡µé¢åŠ è½½ï¼šå§‹ç»ˆå¼¹æˆæƒæ¡†ï¼ˆæœ‰æ•ˆåˆ™â€œç»§ç»­ä½¿ç”¨â€ï¼Œæ— æ•ˆåˆ™â€œéªŒè¯å¹¶ç»§ç»­â€ï¼‰
        function lockAllMainButtons(lock){
            const ids = [
                'startBrowserBtn','stopAllServicesBtn','startLikeBtn','stopLikeBtn',
                'startStage1Btn','stopStage1Btn','startStage2Btn','stopStage2Btn',
                'startMessageBtn','stopMessageBtn','stage2WithSelectedBtn','sendToSelectedBtn',
                'clearDataBtn','refreshVideosBtn','refreshUsersBtn','selectAllVideosBtn',
                'clearVideosSelectionBtn','selectAllUsersBtn','clearUsersSelectionBtn'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = !!lock;
            });
        }

        function bindLicenseUI(){
            const okBtn=document.getElementById('licenseOkBtn');
            const qBtn=document.getElementById('licenseQuitBtn');
            // åˆå§‹é»˜è®¤è®©â€œç¡®å®šâ€å» doActivateï¼ŒshowLicenseModalAlways ä¼šæŒ‰çŠ¶æ€è¦†ç›–å®ƒ
            if (okBtn) okBtn.onclick = doActivate;
            if (qBtn) qBtn.onclick = () => { try{ fetch('/api/app/quit',{method:'POST'}) }catch(e){} window.close(); };
        }

        function initializeApp() {
            // ä»localStorageåŠ è½½é€‰æ‹©çŠ¶æ€
            loadSelectionFromStorage();
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindEventListeners();
            
            // åˆå§‹åŒ–é€‰æ¡†
            initializeMarquee();
            
            // è¿æ¥WebSocket
            connectWebSocket();
            
            // åˆå§‹åŒ–æ•°æ®
            refreshStats();
            refreshVideos();
            refreshUsers();
            
            // è®¾ç½®å®šæœŸåˆ·æ–°
            setInterval(refreshStats, 2000);
            setInterval(refreshVideos, 3000);
            setInterval(refreshUsers, 3000);
            
            // æ›´æ–°é€‰æ‹©ä¿¡æ¯
            updateSelectionInfo();
            startLicenseHeartbeat();
        }
        
        function bindEventListeners() {
            // æ‰‹åŠ¨æ·»åŠ è§†é¢‘
            const openAddVideoModalBtn = document.getElementById('openAddVideoModalBtn');
            if (openAddVideoModalBtn) openAddVideoModalBtn.onclick = () => {
                document.getElementById('addVideoModal').style.display = 'flex';
            };

            const closeAddVideoModalBtn = document.getElementById('closeAddVideoModalBtn');
            if (closeAddVideoModalBtn) closeAddVideoModalBtn.onclick = () => {
                document.getElementById('addVideoModal').style.display = 'none';
            };

            // ç¡®è®¤æ·»åŠ è§†é¢‘
            const confirmAddVideoBtn = document.getElementById('confirmAddVideoBtn');
            if (confirmAddVideoBtn) confirmAddVideoBtn.onclick = async () => {
                const url = document.getElementById('manualVideoUrl').value.trim();
                const desc = document.getElementById('manualVideoDesc').value.trim();
                const kw = document.getElementById('manualVideoKeyword').value.trim();
                const author = document.getElementById('manualVideoAuthor').value.trim();
                const like = document.getElementById('manualVideoLike').value.trim();

                if (!url) {
                    addLog("âŒ è§†é¢‘é“¾æ¥ä¸èƒ½ä¸ºç©º", "error");
                    return;
                }

                const result = await apiCall("/api/videos/add_manual", {
                    body: JSON.stringify({
                        video_url: url,
                        video_desc: desc,
                        keyword: kw,
                        author_name: author,
                        like_count: Number(like)
                    })
                });

                if (result.status === "success") {
                    addLog("âœ… è§†é¢‘å·²æ·»åŠ ", "success");
                    document.getElementById('addVideoModal').style.display = 'none';
                    refreshVideos();
                } else {
                    addLog("âŒ æ·»åŠ å¤±è´¥ï¼š" + result.message, "error");
                }
            };
            // â€”â€” è·å–é€‰ä¸­è§†é¢‘è¯¦ç»†æ•°æ® â€”â€” 
            const enrichSelectedVideosBtn = document.getElementById('enrichSelectedVideosBtn');
            if (enrichSelectedVideosBtn) {
                enrichSelectedVideosBtn.onclick = async () => {
                    // æ²¡é€‰è§†é¢‘ï¼Œç›´æ¥æç¤º
                    if (selectedVideos.size === 0) {
                        addLog('âŒ è¯·å…ˆå‹¾é€‰è‡³å°‘ä¸€ä¸ªè§†é¢‘', 'error');
                        return;
                    }

                    const videoUrls = [...selectedVideos];

                    addLog(`ğŸ” å¼€å§‹ä¸º ${videoUrls.length} ä¸ªé€‰ä¸­è§†é¢‘è·å–è¯¦ç»†æ•°æ®`, 'info');

                    try {
                        const result = await apiCall('/api/videos/enrich_details', {
                            body: JSON.stringify({
                                video_urls: videoUrls
                            })
                        });

                        if (result.status === 'success') {
                            addLog(`âœ… ${result.message || 'è·å–è§†é¢‘è¯¦ç»†æ•°æ®ä»»åŠ¡å·²è§¦å‘'}`, 'success');
                            // è·å–å®Œä¹‹ååˆ·æ–°ä¸€æ¬¡è§†é¢‘åˆ—è¡¨
                            await refreshVideos();
                        } else {
                            addLog(`âŒ è·å–è§†é¢‘è¯¦ç»†æ•°æ®å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                        }
                    } catch (e) {
                        console.error(e);
                        addLog('âŒ è·å–è§†é¢‘è¯¦ç»†æ•°æ®è¯·æ±‚å¼‚å¸¸', 'error');
                    }
                };
            }

            // ç»‘å®šæ‰€æœ‰æŒ‰é’®çš„é˜²æŠ–äº‹ä»¶
            const videoSortSel = document.getElementById('videoSort');

            
            const userSortSel = document.getElementById('userSort');
            
            // document.getElementById('videoSort')?.addEventListener('change', refreshVideos);
            // document.getElementById('userSort')?.addEventListener('change', refreshUsers);
            document.getElementById('videoSort')?.addEventListener('change', (e) => {
                e.stopPropagation();
                refreshVideos();
            });
            document.getElementById('userSort')?.addEventListener('change', (e) => {
                e.stopPropagation();
                refreshUsers();
            });
            const startBrowserBtn = document.getElementById('startBrowserBtn');
            if (startBrowserBtn) startBrowserBtn.onclick = (e) => withBtnLock(e.currentTarget, startBrowser);
            
            const stopAllServicesBtn = document.getElementById('stopAllServicesBtn');
            if (stopAllServicesBtn) stopAllServicesBtn.onclick = (e) => withBtnLock(e.currentTarget, stopAllServices);
            
            const startLikeBtn = document.getElementById('startLikeBtn');
            if (startLikeBtn) startLikeBtn.onclick = (e) => withBtnLock(e.currentTarget, startRandomLike);
            
            const stopLikeBtn = document.getElementById('stopLikeBtn');
            if (stopLikeBtn) stopLikeBtn.onclick = (e) => withBtnLock(e.currentTarget, stopRandomLike);
            
            const startStage1Btn = document.getElementById('startStage1Btn');
            if (startStage1Btn) startStage1Btn.onclick = (e) => withBtnLock(e.currentTarget, startStage1CollectVideos);
            
            const stopStage1Btn = document.getElementById('stopStage1Btn');
            if (stopStage1Btn) stopStage1Btn.onclick = (e) => withBtnLock(e.currentTarget, stopStage1CollectVideos);
            
            const startStage2Btn = document.getElementById('startStage2Btn');
            if (startStage2Btn) startStage2Btn.onclick = (e) => withBtnLock(e.currentTarget, startStage2CollectUsers);
            
            const stopStage2Btn = document.getElementById('stopStage2Btn');
            if (stopStage2Btn) stopStage2Btn.onclick = (e) => withBtnLock(e.currentTarget, stopStage2CollectUsers);
            async function loadSavedAccounts() {
                try {
                const resp = await fetch('/api/accounts/saved');
                const j = await resp.json();
                if (j.status === 'success') {
                document.getElementById('accountDirs').value = (j.data || []).join('\n');
                addLog('å·²è½½å…¥å·²ä¿å­˜è´¦å·åˆ—è¡¨', 'success');
                } else {
                addLog('è¯»å–å·²ä¿å­˜è´¦å·åˆ—è¡¨å¤±è´¥: ' + (j.message || ''), 'error');
                }
            } catch (e) {
                addLog('è¯»å–å·²ä¿å­˜è´¦å·åˆ—è¡¨å¼‚å¸¸: ' + e, 'error');
            }
            }
            async function ensureRootFilled() {
                const input = document.getElementById('accountsRoot');
                let root = (input?.value || '').trim();
                if (!root) {
                    try {
                        const resp = await fetch('/api/accounts/default_root');
                        const j = await resp.json();
                        if (j.status === 'success' && j.data) {
                            input.value = j.data;
                            root = j.data;
                            addLog('ğŸ“ å·²è‡ªåŠ¨åˆ›å»ºè´¦å·æ ¹ç›®å½•ï¼š' + j.data, 'success');
                        } else {
                            addLog('æ— æ³•åˆå§‹åŒ–è´¦å·æ ¹ç›®å½•ï¼š' + (j.message || ''), 'error');
                        }
                    } catch (e) {
                        addLog('åˆå§‹åŒ–è´¦å·æ ¹ç›®å½•å¼‚å¸¸ï¼š' + e, 'error');
                    }
                }
                return root;
            }
            async function scanAccounts() {
            try {
                const root = await ensureRootFilled();
                if (!root) { alert('æ— æ³•åˆå§‹åŒ–è´¦å·æ ¹ç›®å½•'); return; }
                const resp = await fetch('/api/accounts/list?root=' + encodeURIComponent(root));

                const j = await resp.json();
                if (j.status === 'success') {
                document.getElementById('accountDirs').value = (j.data || []).join('\n');
                addLog(`æ‰«æå®Œæˆï¼Œå…±å‘ç° ${ (j.data || []).length } ä¸ªå­ç›®å½•`, 'success');
                } else {
                addLog('æ‰«æå¤±è´¥: ' + (j.message || ''), 'error');
                }
            } catch (e) {
                addLog('æ‰«æå¼‚å¸¸: ' + e, 'error');
            }
            }

            async function saveAccounts() {
            try {
                const raw = document.getElementById('accountDirs').value || '';
                const profiles = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                const resp = await fetch('/api/accounts/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ profiles })
                });
                const j = await resp.json();
                if (j.status === 'success') {
                addLog(j.message || 'ä¿å­˜æˆåŠŸ', 'success');
                } else {
                addLog('ä¿å­˜å¤±è´¥: ' + (j.message || ''), 'error');
                }
            } catch (e) {
                addLog('ä¿å­˜å¼‚å¸¸: ' + e, 'error');
            }
            }
            async function loginThisAccount() {
                try {
                    const ta = document.getElementById('accountDirs');
                    if (!ta) { addLog('æ‰¾ä¸åˆ°è´¦å·åˆ—è¡¨è¾“å…¥æ¡†', 'error'); return; }

                    // å–å…‰æ ‡æ‰€åœ¨è¡Œ
                    const val = ta.value || '';
                    const pos = ta.selectionStart ?? 0;
                    const start = val.lastIndexOf('\n', Math.max(0, pos - 1)) + 1;
                    const end = (val.indexOf('\n', pos) === -1) ? val.length : val.indexOf('\n', pos);
                    const line = val.slice(start, end).trim();
                    if (!line) { alert('è¯·æŠŠå…‰æ ‡æ”¾åœ¨éœ€è¦æ‰«ç ç™»å½•çš„â€œé‚£ä¸€è¡Œç›®å½•â€ä¸Š'); return; }

                    const resp = await fetch('/api/accounts/open', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ dir: line })
                    });
                    const j = await resp.json();
                    if (j.status === 'success') {
                        addLog(j.message || 'âœ… å·²åˆ‡æ¢å¹¶æ‰“å¼€æµè§ˆå™¨ï¼Œè¯·åœ¨æ–°çª—å£æ‰«ç ', 'success');
                    } else {
                        addLog('âŒ ' + (j.message || 'æ‰“å¼€å¤±è´¥'), 'error');
                    }
                } catch (e) {
                    addLog('âŒ æ‰§è¡Œæ‰«ç ç™»å½•å¤±è´¥ï¼š' + e, 'error');
                }
            }

            async function createAndLogin() {
                try {
                    const root = await ensureRootFilled();
                    if (!root) { alert('æ— æ³•åˆå§‹åŒ–è´¦å·æ ¹ç›®å½•'); return; }
                    const resp = await fetch('/api/accounts/create', {

                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ root })
                    });
                    const j = await resp.json();
                    if (j.status === 'success') {
                        addLog(j.message || 'âœ… å·²åˆ›å»ºç›®å½•å¹¶æ‰“å¼€æµè§ˆå™¨æ‰«ç ', 'success');
                        await loadSavedAccounts();   // åˆ·æ–°æ–‡æœ¬æ¡†ä¸ºæœ€æ–°ä¿å­˜åˆ—è¡¨
                    } else {
                        addLog('âŒ ' + (j.message || 'åˆ›å»º/æ‰“å¼€å¤±è´¥'), 'error');
                    }
                } catch (e) {
                    addLog('âŒ åˆ›å»ºå¹¶æ‰«ç å¤±è´¥ï¼š' + e, 'error');
                }
            }

            /* ç»‘å®šæŒ‰é’® */
            document.getElementById('scanAccountsBtn') .addEventListener('click', scanAccounts);
            document.getElementById('loadAccountsBtn') .addEventListener('click', loadSavedAccounts);
            document.getElementById('saveAccountsBtn') .addEventListener('click', saveAccounts);
            // document.getElementById('loginThisAccountBtn').addEventListener('click', loginThisAccount);
            document.getElementById('createAndLoginBtn').addEventListener('click', createAndLogin);
            /* é¡µé¢åŠ è½½æ—¶å°è¯•åŠ è½½å·²ä¿å­˜è´¦å·åˆ—è¡¨ï¼ˆå¯é€‰ï¼Œä¸å½±å“åŸæœ‰é€»è¾‘ï¼‰ */
            document.addEventListener('DOMContentLoaded', () => {
            loadSavedAccounts().catch(()=>{});
            });
            const startMessageBtn = document.getElementById('startMessageBtn');
            if (startMessageBtn) startMessageBtn.onclick = (e) => withBtnLock(e.currentTarget, startSendMessages);
            const rotateAccounts = document.getElementById('rotateAccounts');
            const accountDirsBox = document.getElementById('accountDirsBox');
            if (rotateAccounts && accountDirsBox) {
                rotateAccounts.addEventListener('change', () => {
                    accountDirsBox.style.display = rotateAccounts.checked ? 'block' : 'none';
                });
            }

            const stopMessageBtn = document.getElementById('stopMessageBtn');
            if (stopMessageBtn) stopMessageBtn.onclick = (e) => withBtnLock(e.currentTarget, stopSendMessages);
            
            const stage2WithSelectedBtn = document.getElementById('stage2WithSelectedBtn');
            if (stage2WithSelectedBtn) stage2WithSelectedBtn.onclick = (e) => withBtnLock(e.currentTarget, startStage2WithSelectedVideos);
            
            const sendToSelectedBtn = document.getElementById('sendToSelectedBtn');
            if (sendToSelectedBtn) sendToSelectedBtn.onclick = (e) => withBtnLock(e.currentTarget, startSendMessagesToSelectedUsers);
            
            // æ‰¹é‡æ“ä½œæŒ‰é’®
            const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) selectAllBtn.onclick = selectAll;
            
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            if (clearSelectionBtn) clearSelectionBtn.onclick = clearSelection;
            
            const clearDataBtn = document.getElementById('clearDataBtn');
            if (clearDataBtn) clearDataBtn.onclick = showClearDataModal;
            
            // è§†é¢‘ç‰¹å®šæŒ‰é’®
            const selectAllVideosBtn = document.getElementById('selectAllVideosBtn');
            if (selectAllVideosBtn) selectAllVideosBtn.onclick = selectAllVideos;
            
            const clearVideosSelectionBtn = document.getElementById('clearVideosSelectionBtn');
            if (clearVideosSelectionBtn) clearVideosSelectionBtn.onclick = clearVideosSelection;
            
            const refreshVideosBtn = document.getElementById('refreshVideosBtn');
            if (refreshVideosBtn) refreshVideosBtn.onclick = refreshVideos;
            
            // ç”¨æˆ·ç‰¹å®šæŒ‰é’®
            const selectAllUsersBtn = document.getElementById('selectAllUsersBtn');
            if (selectAllUsersBtn) selectAllUsersBtn.onclick = selectAllUsers;
            
            const clearUsersSelectionBtn = document.getElementById('clearUsersSelectionBtn');
            if (clearUsersSelectionBtn) clearUsersSelectionBtn.onclick = clearUsersSelection;
            
            const refreshUsersBtn = document.getElementById('refreshUsersBtn');
            if (refreshUsersBtn) refreshUsersBtn.onclick = refreshUsers;
            
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            if (clearLogsBtn) clearLogsBtn.onclick = clearLogs;
            
            // æ¨¡æ€æ¡†æŒ‰é’®
            const cancelClearBtn = document.getElementById('cancelClearBtn');
            if (cancelClearBtn) cancelClearBtn.onclick = hideClearDataModal;
            
            const confirmClearBtn = document.getElementById('confirmClearBtn');
            if (confirmClearBtn) confirmClearBtn.onclick = confirmClearData;
            
            // æ¨¡æ€æ¡†è¾“å…¥ç›‘å¬
            const clearDataConfirm = document.getElementById('clearDataConfirm');
            if (clearDataConfirm) clearDataConfirm.addEventListener('input', validateClearConfirmation);
            
            const clearDataScope = document.getElementById('clearDataScope');
            if (clearDataScope) clearDataScope.addEventListener('change', toggleDaysInput);
            
            // é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // è®¾ç½®é¡¹ç›®é€‰æ‹©ç›‘å¬
            setTimeout(setupItemSelection, 1000);
            startLicenseHeartbeat();
        }
        function startLicenseHeartbeat(){
            // æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆä½ ä¹Ÿå¯ä»¥è°ƒæˆ 60 ç§’ï¼‰
            setInterval(async ()=>{
                try{
                    const r = await fetch('/api/license/status');
                    const j = await r.json();
                    const d = (j && j.data) ? j.data : {};
                    const licExp = Number(d.lic_exp || d.license_exp || 0);
                    const tokExp = Number(d.token_exp || d.exp || 0);
                    const nowSec = Math.floor(Date.now()/1000);
                    const expired = (d.expired === true) ||
                                    (licExp > 0 && nowSec >= licExp) ||
                                    (tokExp > 0 && nowSec >= tokExp);

                    if (expired || d.valid !== true) {
                        if (typeof lockAllMainButtons==='function') lockAllMainButtons(true);
                        await showLicenseModalAlways();
                    }
                }catch(_){}
            }, 30000);
        }
        function initializeMarquee() {
            const marquee = document.getElementById('marquee');
            const videosList = document.getElementById('videosList');
            const usersList = document.getElementById('usersList');
            
            [videosList, usersList].forEach(container => {
                if (container) {
                    container.addEventListener('mousedown', startMarqueeSelection);
                    container.addEventListener('mousemove', updateMarqueeSelection);
                    container.addEventListener('mouseup', endMarqueeSelection);
                }
            });
            
            // é˜²æ­¢é€‰æ¡†è§¦å‘æ–‡æœ¬é€‰æ‹©
            document.addEventListener('selectstart', function(e) {
                if (isMarqueeSelecting) {
                    e.preventDefault();
                }
            });
        }
        
        // é€‰æ¡†é€‰æ‹©åŠŸèƒ½
        function startMarqueeSelection(e) {
            if (e.button !== 0) return; // åªå¤„ç†å·¦é”®
            if (e.target.type === 'checkbox') return; // å¤é€‰æ¡†ç‚¹å‡»ä¸è§¦å‘é€‰æ¡†
            
            isMarqueeSelecting = true;
            isAltPressed = e.altKey;
            
            const rect = e.currentTarget.getBoundingClientRect();
            marqueeStart.x = e.clientX - rect.left;
            marqueeStart.y = e.clientY - rect.top;
            marqueeEnd.x = marqueeStart.x;
            marqueeEnd.y = marqueeStart.y;
            
            const marquee = document.getElementById('marquee');
            marquee.style.display = 'block';
            marquee.style.left = marqueeStart.x + 'px';
            marquee.style.top = marqueeStart.y + 'px';
            marquee.style.width = '0px';
            marquee.style.height = '0px';
            
            e.preventDefault();
        }
        
        function updateMarqueeSelection(e) {
            if (!isMarqueeSelecting) return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            marqueeEnd.x = e.clientX - rect.left;
            marqueeEnd.y = e.clientY - rect.top;
            
            const marquee = document.getElementById('marquee');
            const left = Math.min(marqueeStart.x, marqueeEnd.x);
            const top = Math.min(marqueeStart.y, marqueeEnd.y);
            const width = Math.abs(marqueeEnd.x - marqueeStart.x);
            const height = Math.abs(marqueeEnd.y - marqueeStart.y);
            
            marquee.style.left = left + 'px';
            marquee.style.top = top + 'px';
            marquee.style.width = width + 'px';
            marquee.style.height = height + 'px';
            
            // å®æ—¶æ›´æ–°é€‰æ‹©
            updateSelectionFromMarquee(e.currentTarget, left, top, width, height);
        }
        
        function endMarqueeSelection(e) {
            if (!isMarqueeSelecting) return;
            
            isMarqueeSelecting = false;
            document.getElementById('marquee').style.display = 'none';
            
            // ä¿å­˜é€‰æ‹©çŠ¶æ€
            saveSelectionToStorage();
            updateSelectionInfo();
        }
        
        function updateSelectionFromMarquee(container, left, top, width, height) {
            const marqueeRect = { left, top, right: left + width, bottom: top + height };
            const items = container.querySelectorAll('.user-item, .video-item');
            const currentTab = document.querySelector('.tab.active').getAttribute('onclick').includes('videos') ? 'videos' : 'users';
            
            items.forEach((item, index) => {
                const rect = item.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                const itemRect = {
                    left: rect.left - containerRect.left,
                    top: rect.top - containerRect.top,
                    right: rect.right - containerRect.left,
                    bottom: rect.bottom - containerRect.top
                };
                
                // æ£€æµ‹çŸ©å½¢ç›¸äº¤
                const intersects = !(marqueeRect.right < itemRect.left || 
                                   marqueeRect.left > itemRect.right || 
                                   marqueeRect.bottom < itemRect.top || 
                                   marqueeRect.top > itemRect.bottom);
                
                if (intersects) {
                    const key = item.querySelector('input[type="checkbox"]')?.dataset.key;
                    if (key) {
                        if (isAltPressed) {
                            // Alté”®æŒ‰ä¸‹ï¼Œå–æ¶ˆé€‰æ‹©
                            if (currentTab === 'videos') {
                                selectedVideos.delete(key);
                            } else {
                                selectedUsers.delete(key);
                            }
                        } else {
                            // æ­£å¸¸é€‰æ‹©
                            if (currentTab === 'videos') {
                                selectedVideos.add(key);
                            } else {
                                selectedUsers.add(key);
                            }
                        }
                    }
                }
            });
            
            // æ›´æ–°UI
            reapplySelection(currentTab);
        }
        
        // é€‰æ‹©æŒä¹…åŒ–åŠŸèƒ½
        function loadSelectionFromStorage() {
            try {
                const savedVideos = localStorage.getItem('selectedVideos');
                const savedUsers = localStorage.getItem('selectedUsers');
                
                if (savedVideos) {
                    selectedVideos = new Set(JSON.parse(savedVideos));
                }
                if (savedUsers) {
                    selectedUsers = new Set(JSON.parse(savedUsers));
                }
            } catch (e) {
                console.error('åŠ è½½é€‰æ‹©çŠ¶æ€å¤±è´¥:', e);
            }
        }
        
        function saveSelectionToStorage() {
            try {
                localStorage.setItem('selectedVideos', JSON.stringify([...selectedVideos]));
                localStorage.setItem('selectedUsers', JSON.stringify([...selectedUsers]));
            } catch (e) {
                console.error('ä¿å­˜é€‰æ‹©çŠ¶æ€å¤±è´¥:', e);
            }
        }
        
        function reapplySelection(type) {
            const container = type === 'videos' ? document.getElementById('videosList') : document.getElementById('usersList');
            const selectedSet = type === 'videos' ? selectedVideos : selectedUsers;
            
            if (!container) return;
            
            // è™šæ‹Ÿåˆ—è¡¨ï¼šåªæ›´æ–°å¯è§åŒºï¼Œå› ä¸ºä¸å¯è§åŒºæ²¡æœ‰ DOM
            const rows = container.querySelectorAll('.virtual-row');

            rows.forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (!checkbox) return;

                const key = checkbox.dataset.key;
                const checked = selectedSet.has(key);

                checkbox.checked = checked;

                // æ›´æ–°è¡Œçš„é€‰ä¸­æ ·å¼
                if (checked) row.classList.add('selected');
                else row.classList.remove('selected');
            });

            
            // æ›´æ–°ç‰¹å®šé€‰æ‹©ä¿¡æ¯
            if (type === 'videos') {
                updateVideosSelectionInfo();
            } else {
                updateUsersSelectionInfo();
            }
        }
        // ç»Ÿä¸€æŠŠå·²åˆ é™¤/å·²ä¸åœ¨åˆ—è¡¨ä¸­çš„ id ä» selectedSets é‡Œç§»é™¤ï¼Œä¿æŒé›†åˆä¸å½“å‰æ•°æ®ä¸€è‡´
        function reconcileSelection(type) {
            if (type === 'videos') {
                const currentIds = new Set((window.__videosList || []).map(v => String(v.id)));
                selectedVideos = new Set([...selectedVideos].filter(id => currentIds.has(String(id))));
                if (typeof videosListVirtual !== 'undefined') videosListVirtual.update();
                saveSelectionToStorage?.();
                updateVideosSelectionInfo?.();
            } else {
                const currentIds = new Set((window.__usersList || []).map(u => String(u.id)));
                selectedUsers = new Set([...selectedUsers].filter(id => currentIds.has(String(id))));
                if (typeof usersListVirtual !== 'undefined') usersListVirtual.update();
                saveSelectionToStorage?.();
                updateUsersSelectionInfo?.();
            }
        }

        // æ‰¹é‡é€‰æ‹©åŠŸèƒ½
        function selectAll() {
            const currentTab = document.querySelector('.tab.active').getAttribute('onclick').includes('videos') ? 'videos' : 'users';
            if (currentTab === 'videos') {
                selectAllVideos();
            } else {
                selectAllUsers();
            }
        }
        
        function selectAllVideos() {
            selectedVideos = new Set(window.__videosList.map(v => String(v.id)));
            videosListVirtual.update();
            saveSelectionToStorage();
            updateVideosSelectionInfo();
        }

        
        function selectAllUsers() {
            selectedUsers = new Set(window.__usersList.map(u => String(u.id)));
            usersListVirtual.update();
            saveSelectionToStorage();
            updateUsersSelectionInfo();
        }

        
        function clearSelection() {
            const currentTab = document.querySelector('.tab.active').getAttribute('onclick').includes('videos') ? 'videos' : 'users';
            if (currentTab === 'videos') {
                clearVideosSelection();
            } else {
                clearUsersSelection();
            }
        }
        
        function clearVideosSelection() {
            selectedVideos.clear();
            reapplySelection('videos');
            saveSelectionToStorage();
            updateVideosSelectionInfo();
        }
        
        function clearUsersSelection() {
            selectedUsers.clear();
            reapplySelection('users');
            saveSelectionToStorage();
            updateUsersSelectionInfo();
        }
        
        function updateSelectionInfo() {
            const currentTab = document.querySelector('.tab.active')
                .getAttribute('onclick')
                .includes('videos') ? 'videos' : 'users';
            if (currentTab === 'videos') {
                updateVideosSelectionInfo();
            } else {
                updateUsersSelectionInfo();
            }
        }
        
        function updateVideosSelectionInfo() {
            document.getElementById('videosSelectionInfo').textContent = `å·²é€‰ ${selectedVideos.size} é¡¹`;
        }
        
        function updateUsersSelectionInfo() {
            document.getElementById('usersSelectionInfo').textContent = `å·²é€‰ ${selectedUsers.size} é¡¹`;
        }
        
        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyDown(e) {
            if (e.key === 'Shift') {
                isShiftPressed = true;
            }
            if (e.key === 'Alt') {
                isAltPressed = true;
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                selectAll();
            }
            if (e.key === 'Escape') {
                clearSelection();
            }
        }
        
        function handleKeyUp(e) {
            if (e.key === 'Shift') {
                isShiftPressed = false;
            }
            if (e.key === 'Alt') {
                isAltPressed = false;
            }
        }
        
        // æ¸…é™¤æ•°æ®åŠŸèƒ½
        function showClearDataModal() {
            document.getElementById('clearDataModal').style.display = 'flex';
            document.getElementById('clearDataConfirm').value = '';
            document.getElementById('confirmClearBtn').disabled = true;
        }
        
        function hideClearDataModal() {
            document.getElementById('clearDataModal').style.display = 'none';
        }
        
        function toggleDaysInput() {
            const scope = document.getElementById('clearDataScope').value;
            const daysContainer = document.getElementById('daysInputContainer');
            daysContainer.style.display = scope === 'days' ? 'block' : 'none';
        }
        
        function validateClearConfirmation() {
            const input = document.getElementById('clearDataConfirm');
            const button = document.getElementById('confirmClearBtn');
            button.disabled = input.value !== 'DELETE';
        }
        
        async function confirmClearData() {
            const type  = document.getElementById('clearDataType').value;   // 'videos' | 'users' | 'task_logs'
            let scope = document.getElementById('clearDataScope').value;  // 'all' | 'selected' | 'days' | 'sent' | 'unsent'
            if (type === 'users') {
            const map = {
                'sent-users': 'sent',
                'only-sent-users': 'sent',
                'unsent-users': 'unsent',
                'only-unsent-users': 'unsent',
                'pending-users': 'unsent'
            };
            scope = map[scope] || scope;   // æœªå‘½ä¸­ä¿æŒåŸå€¼
            }
            const days  = parseInt(document.getElementById('clearDataDays').value || '7', 10);
            const selectedIds = type === 'videos'
                ? [...selectedVideos]           // video_url å­—ç¬¦ä¸²
                : (type === 'users' ? [...selectedUsers] : []); // user_url å­—ç¬¦ä¸²

            const url = `/api/${type}`;


            // 2) äºŒæ¬¡ç¡®è®¤ï¼ˆè¾“å…¥æ¡†é‡Œå¿…é¡»æ˜¯ DELETEï¼‰
            const confirmInput = document.getElementById('clearDataConfirm');
            if (!confirmInput || confirmInput.value !== "DELETE") {
                alert('è¯·è¾“å…¥ DELETE ç¡®è®¤æ“ä½œ');
                return;
            }

            // 3) é€‰ä¸­ idï¼ˆæ³¨æ„ï¼šå¿…é¡»æ˜¯ idï¼Œä¸æ˜¯ urlï¼‰
            // const selectedIds = type === 'videos'
            //     ? Array.from(selectedVideos)  // Set<number>
            //     : Array.from(selectedUsers);  // Set<number>

            // // 4) æ­£ç¡®çš„åç«¯è·¯å¾„
            // const url = `/api/${type}`;  // /api/videos | /api/users | /api/task_logs

            // 5) ç»„è£…è¯·æ±‚ä½“ï¼ˆä»…åœ¨ç›¸åº” scope ä¸‹æºå¸¦ ids / daysï¼‰
            const payload = {
                scope: scope,
                ids: scope === 'selected' ? selectedIds : undefined,
                days: scope === 'days' ? days : undefined
            };

            try {
                // 6) å‘ DELETE + JSONï¼ˆä¸€å®šè¦å¸¦ Content-Typeï¼‰
                const resp = await fetch(url, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await resp.json();

                if (resp.ok && data?.status === 'success') {
                    // å†™æ—¥å¿—
                    addLog(`ğŸ—‘ æ¸…é™¤æˆåŠŸï¼š${data.message}`, 'success');
                    hideClearDataModal();
                    // æˆåŠŸååˆ·æ–°å¯¹åº”åˆ—è¡¨ + æ¸…ç©ºå·²é€‰
                    if (type === 'videos') {
                        selectedVideos.clear();
                        if (typeof videosListVirtual !== 'undefined') videosListVirtual.update();
                        if (typeof refreshVideos === 'function') refreshVideos();
                        updateVideosSelectionInfo?.();
                    } else if (type === 'users') {
                        selectedUsers.clear();
                        if (typeof usersListVirtual !== 'undefined') usersListVirtual.update();
                        if (typeof refreshUsers === 'function') refreshUsers();
                        updateUsersSelectionInfo?.();
                    } else if (type === 'task_logs') {
                        // ä½ è‹¥æœ‰æ—¥å¿—é¢æ¿ï¼Œæ¸…ä¸€ä¸‹
                        document.getElementById('logContainer')?.querySelector('.log-content')?.replaceChildren();
                    }
                    saveSelectionToStorage?.();
                    updateVideosSelectionInfo?.();
                    updateUsersSelectionInfo?.();

                } else {
                    addLog(`âŒ æ¸…é™¤å¤±è´¥ï¼š${data?.message || resp.statusText}`, 'error');

                }
            } catch (err) {
                addLog(`âŒ æ¸…é™¤å¤±è´¥ï¼š${String(err)}`, 'error');

            }
        }
                
        // å·¥å…·å‡½æ•°
        function toggleAdvanced(id) {
            const element = document.getElementById(id);
            element.classList.toggle('show');
        }
        
        function switchTab(tabName,el) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));

            // document.querySelectorAll('.tab-content').forEach(tab => {
            //     tab.classList.remove('active');
            // });
            if (el) el.classList.add('active');
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            // document.querySelectorAll('.tab').forEach(tab => {
            //     tab.classList.remove('active');
            // });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
            // document.getElementById(tabName + 'Tab').classList.add('active');
            
            // // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            // event.target.classList.add('active');
            
            // // åˆ·æ–°å¯¹åº”æ•°æ®
            // if (tabName === 'users') {
            //     refreshUsers();
            // } else if (tabName === 'videos') {
            //     refreshVideos();
            // }
            
            // // æ›´æ–°é€‰æ‹©ä¿¡æ¯
            // updateSelectionInfo();
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }
        
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('ğŸ“ æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        // æŒ‰é’®é˜²æŠ–é”å®šå‡½æ•°
        async function withBtnLock(btn, fn) {
            if (btn.dataset.lock === "1") return;
            btn.dataset.lock = "1";
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = "ğŸ”„ æ‰§è¡Œä¸­...";
            try { 
                return await fn(); 
            }
            finally { 
                btn.disabled = false; 
                btn.dataset.lock = "0";
                btn.textContent = originalText;
            }
        }
        function handler(e) {
            const checkbox = e.target;
            if (checkbox.tagName !== "INPUT" || checkbox.type !== "checkbox") return;

            const key = checkbox.dataset.key;
            const currentTab = location.hash.includes("videos")
                ? "videos"
                : (document.querySelector('.tab.active').textContent.includes("è§†é¢‘") ? "videos" : "users");

            const selectedSet = currentTab === "videos" ? selectedVideos : selectedUsers;

            if (checkbox.checked) selectedSet.add(key);
            else selectedSet.delete(key);

            saveSelectionToStorage();
            reapplySelection(currentTab);
        }

        // è®¾ç½®é¡¹ç›®é€‰æ‹©ç›‘å¬
        function setupItemSelection() {
            // è§†é¢‘é€‰æ‹©
            document
            .querySelector('#videosList .virtual-list-inner')
            .addEventListener('change', handler)

            
            // ç”¨æˆ·é€‰æ‹©
            document
            .querySelector('#usersList .virtual-list-inner')
            .addEventListener('change', handler)

        }
        
        // WebSocketè¿æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                updateConnectionStatus(true);
                addLog('âœ… å·²è¿æ¥åˆ°ç³»ç»Ÿ', 'success');
                
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                updateConnectionStatus(false);
                addLog('âŒ è¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡è¿...', 'error');
                
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };
            
            ws.onerror = function(error) {
                addLog('âŒ WebSocketé”™è¯¯', 'error');
            };
        }
        
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'connected':
                    addLog(data.msg, 'success');
                    break;
                case 'operation':
                    addLog(data.msg, 'info');
                    break;
                case 'error':
                    addLog(data.msg, 'error');
                    
                    break;
                case 'pong':
                    break;
                default:
                    addLog(JSON.stringify(data), 'info');
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = 'ğŸŸ¢ å·²è¿æ¥';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'ğŸ”´ æœªè¿æ¥';
                statusElement.className = 'connection-status disconnected';
            }
        }
        
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            if (logContainer.children.length > 1000) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
        
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    ...options
                });
                
                const data = await response.json();
                return data;
            } catch (error) {
                addLog(`âŒ APIè°ƒç”¨å¤±è´¥: ${error}`, 'error');
                return { status: 'error', message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' };
            }
        }
        
        // åŸæœ‰çš„APIå‡½æ•°ä¿æŒä¸å˜
        async function startBrowser() {
            addLog('ğŸ–¥ï¸ æ­£åœ¨å¯åŠ¨æµè§ˆå™¨...', 'info');
            const result = await apiCall('/api/browser/start');
            if (result.status === 'success') {
                addLog('âœ… ' + result.message, 'success');
            } else {
                addLog('âŒ ' + result.message, 'error');
            }
        }
        // ç»Ÿä¸€çš„é˜¶æ®µäºŒå¯åŠ¨å‡½æ•°
        async function startStage2Unified(opts = { useSelected: false }) {
            const userCommentKeywords = document.getElementById('userCommentKeywords').value;
            const ipKeywords = document.getElementById('ipKeywords').value;
            const duration = document.getElementById('stage2Duration').value || 10;

            if (!userCommentKeywords.trim()) {
                addLog('âŒ è¯·è¾“å…¥ç”¨æˆ·è¯„è®ºå…³é”®è¯', 'error');
                return;
            }

            let videoUrls = '';
            if (opts.useSelected) {
                // é€‰ä¸­é›†åˆé‡Œæ˜¯ idï¼Œè¿™é‡ŒæŠŠ id æ˜ å°„æˆçœŸå® video_url
                const idToUrl = new Map((window.__videosList || []).map(v => [String(v.id), v.video_url]));
                const selIds = [...selectedVideos];
                if (selIds.length === 0) {
                    addLog('âŒ è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªè§†é¢‘', 'error');
                    return;
                }
                const urls = selIds.map(id => idToUrl.get(String(id))).filter(Boolean);
                const miss = selIds.length - urls.length;
                if (urls.length === 0) {
                    addLog('âŒ é€‰ä¸­çš„è§†é¢‘æ²¡æœ‰å¯ç”¨é“¾æ¥', 'error');
                    return;
                }
                if (miss > 0) addLog(`âš ï¸ ${miss} ä¸ªé€‰ä¸­é¡¹ç¼ºå°‘é“¾æ¥ï¼Œå·²è·³è¿‡`, 'warning');

                videoUrls = urls.join(' ');
                addLog(`ğŸ§² ç”¨é€‰ä¸­çš„ ${urls.length} ä¸ªè§†é¢‘é‡‡é›†ç”¨æˆ·`, 'info');
            } else {
                addLog(`ğŸš€ å¼€å§‹é˜¶æ®µäºŒï¼šç”¨æˆ·é‡‡é›†ï¼Œå…³é”®è¯: ${userCommentKeywords}`, 'info');
            }


            // ğŸ”§ æ”¹ä¸ºä½¿ç”¨ JSON Body ä¼ é€’å‚æ•°ï¼ˆåç«¯ç”¨ Body(...) æ¥æ”¶ï¼‰
            const result = await apiCall('/api/stage2_collect_users/start', {
                body: JSON.stringify({
                    user_comment_keywords: userCommentKeywords,
                    ip_keywords: ipKeywords,
                    duration: Number(duration),
                    video_urls: videoUrls
                })
            });

            if (result.status === 'success') {
                addLog('âœ… ' + result.message, 'success');
            } else {
                addLog('âŒ ' + result.message, 'error');
            }
        }


        async function startRandomLike() {
            const duration = document.getElementById('likeDuration').value;
            const likeFrequency = Number(document.getElementById('likeFrequency').value || 60); // 0~100
            addLog(`ğŸš€ å¼€å§‹éšæœºç‚¹èµä»»åŠ¡ï¼Œæ—¶é•¿: ${duration} åˆ†é’Ÿï¼Œç‚¹èµé¢‘ç‡: ${likeFrequency}%`, 'info');
            
            const result = await apiCall(
                `/api/random_like/start?duration=${duration}&like_frequency=${likeFrequency}`
            );
            if (result.status === 'success') {
                likeRunning = true;
                updateServiceStatus();
                addLog('âœ… ' + result.message, 'success');
            } else {
                addLog('âŒ ' + result.message, 'error');
            }
        }
        
        async function stopRandomLike() {
            addLog('ğŸ›‘ åœæ­¢éšæœºç‚¹èµ...', 'info');
            const result = await apiCall('/api/random_like/stop');
            if (result.status === 'success') {
                likeRunning = false;
                updateServiceStatus();
                addLog('âœ… ' + result.message, 'success');
            }
        }
        
        async function startStage1CollectVideos() {
            const keywords = document.getElementById('contentKeywords').value;
            const sortType = document.getElementById('sortType').value;
            const videosPerKeyword = document.getElementById('videosPerKeyword').value;
            const duration = document.getElementById('stage1Duration').value;
            
            if (!keywords.trim()) {
                addLog('âŒ è¯·è¾“å…¥å†…å®¹å…³é”®è¯', 'error');
                return;
            }
            
            addLog(`ğŸš€ å¼€å§‹é˜¶æ®µä¸€ï¼šè§†é¢‘é‡‡é›†ï¼Œå…³é”®è¯: ${keywords}`, 'info');
            
            const result = await apiCall('/api/stage1_collect_videos/start', {
            body: JSON.stringify({
                keywords,                                 // å­—æ®µåä¸åç«¯ä¸€è‡´
                sort_type: sortType,
                videos_per_keyword: Number(videosPerKeyword),
                duration: Number(duration)
            })
            });
            
            if (result.status === 'success') {
                stage1Running = true;
                updateServiceStatus();
                addLog('âœ… ' + result.message, 'success');
            } else {
                addLog('âŒ ' + result.message, 'error');
            }
        }
        
        async function stopStage1CollectVideos() {
            addLog('ğŸ›‘ åœæ­¢é˜¶æ®µä¸€è§†é¢‘é‡‡é›†...', 'info');
            const result = await apiCall('/api/stage1_collect_videos/stop');
            if (result.status === 'success') {
                stage1Running = false;
                updateServiceStatus();
                addLog('âœ… ' + result.message, 'success');
            }
        }
        
        async function startStage2CollectUsers() {
            await startStage2Unified({ useSelected: true });
        }
        
        async function stopStage2CollectUsers() {
            addLog('ğŸ›‘ åœæ­¢é˜¶æ®µäºŒç”¨æˆ·é‡‡é›†...', 'info');
            const result = await apiCall('/api/stage2_collect_users/stop');
            if (result.status === 'success') {
                stage2Running = false;
                updateServiceStatus();
                addLog('âœ… ' + result.message, 'success');
            }
        }
        
        async function startSendMessages() {
            
            const selectedUsersArray = [...selectedUsers];
            const idToUrl = new Map((window.__usersList || []).map(u => [String(u.id), u.user_url]));
            const urls = selectedUsersArray.map(id => idToUrl.get(String(id))).filter(Boolean);
            if (urls.length === 0) { addLog('âŒ é€‰ä¸­çš„ç”¨æˆ·æ²¡æœ‰å¯ç”¨ä¸»é¡µé“¾æ¥', 'error'); return; }
            const messageTemplate = document.getElementById('messageTemplate').value;
            const duration = document.getElementById('messageDuration').value;
            const intervalMinutes = Number(document.getElementById('messageInterval').value || 4); 
            const likeFrequency = Number((document.getElementById('likeFrequency')?.value) ?? 60);
            if (selectedUsersArray.length === 0) {
                addLog('âŒ è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªç”¨æˆ·', 'error');
                return;
            }
            addLog(`ğŸ’Œ å¯¹é€‰ä¸­ ${selectedUsersArray.length} ä½ç”¨æˆ·å‘é€ç§ä¿¡ï¼Œï¼ˆé—´éš” ${intervalMinutes} åˆ†é’Ÿ/äººï¼‰`, 'info');
            
            const result = await apiCall('/api/send_messages/start', {
                body: JSON.stringify({
                    message_template: messageTemplate,
                    duration: Number(duration),
                    user_urls: urls.join(' '),
                    interval_minutes: intervalMinutes,
                    like_frequency: likeFrequency,
                    rotate_accounts: (document.getElementById('rotateAccounts')?.checked ? 1 : 0),
                    account_dirs: (document.getElementById('accountDirs')?.value || '')
                })

            });
            
            if (result.status === 'success') {
                messageRunning = true;
                updateServiceStatus();
                addLog('âœ… ' + result.message, 'success');
            } else {
                addLog('âŒ ' + result.message, 'error');
            }
        }
        
        async function stopSendMessages() {
            addLog('ğŸ›‘ åœæ­¢ç§ä¿¡å‘é€...', 'info');
            const result = await apiCall('/api/send_messages/stop');
            if (result.status === 'success') {
                messageRunning = false;
                updateServiceStatus();
                addLog('âœ… ' + result.message, 'success');
            }
        }
        
        async function stopAllServices() {
            addLog('ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡...', 'info');
            const result = await apiCall('/api/stop_all');
            if (result.status === 'success') {
                likeRunning = false;
                stage1Running = false;
                stage2Running = false;
                messageRunning = false;
                updateServiceStatus();
                addLog('âœ… ' + result.message, 'success');
            }
        }
        
        async function startStage2WithSelectedVideos() {
            await startStage2Unified({ useSelected: true });
        }
        
        async function startSendMessagesToSelectedUsers() {
            // const selectedUsersArray = [...selectedUsers];
            // const messageTemplate = document.getElementById('messageTemplate').value;
            // const duration = document.getElementById('messageDuration').value;
            // const intervalMinutes = Number(document.getElementById('messageInterval').value || 4); 
            // const likeFrequency = Number((document.getElementById('likeFrequency')?.value) ?? 60);
            // if (selectedUsersArray.length === 0) {
            //     addLog('âŒ è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªç”¨æˆ·', 'error');
            //     return;
            // }
            
            // addLog(`ğŸ’Œ å¯¹é€‰ä¸­ ${selectedUsersArray.length} ä½ç”¨æˆ·å‘é€ç§ä¿¡ï¼Œï¼ˆé—´éš” ${intervalMinutes} åˆ†é’Ÿ/äººï¼‰`, 'info');
            
            // const result = await apiCall('/api/stage2_collect_users/start', {
            //     body: JSON.stringify({
            //         user_comment_keywords: userCommentKeywords,
            //         ip_keywords: ipKeywords,
            //         duration: Number(duration),
            //         video_urls: videoUrls
            //     })
            // });
            
            // if (result.status === 'success') {
            //     addLog('âœ… ' + result.message, 'success');
            // } else {
            //     addLog('âŒ ' + (result.message || 'å¯åŠ¨å¤±è´¥'), 'error');
            // }
            return startSendMessages();
        }
        
        function updateServiceStatus() {
            updateStatusElement('like', likeRunning);
            updateStatusElement('stage1', stage1Running);
            updateStatusElement('stage2', stage2Running);
            updateStatusElement('message', messageRunning);
        }
        
        function updateStatusElement(service, isRunning) {
            const indicator = document.getElementById(`${service}StatusIndicator`);
            if (isRunning) {
                indicator.className = 'status-indicator status-running';
            } else {
                indicator.className = 'status-indicator status-stopped';
            }
        }
        
        async function refreshStats() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const stats = data.data.user_stats;
                    const services = data.data.services;
                    const browserStatus = data.data.browser;
                    
                    document.getElementById('totalUsers').textContent = stats.total_users || 0;
                    document.getElementById('pendingUsers').textContent = stats.pending_users || 0;
                    document.getElementById('sentUsers').textContent = stats.sent_users || 0;
                    document.getElementById('todayUsers').textContent = stats.today_users || 0;
                    
                    document.getElementById('browserStatus').textContent = 
                        browserStatus === 'è¿è¡Œä¸­' ? 'ğŸŸ¢' : 'ğŸ”´';
                    browserRunning = browserStatus === 'è¿è¡Œä¸­';
                    
                    likeRunning = services.RandomLikeService?.running || false;
                    const cas = services.CustomerAcquisitionService || {};
                    stage1Running = !!(cas.running && cas.current_stage === 'stage1');  // â˜… æ–°å†™æ³•
                    stage2Running = !!(cas.running && cas.current_stage === 'stage2');  // â˜… æ–°å†™æ³•
                    messageRunning = services.PrivateMessageService?.running || false;
                    
                    updateServiceStatus();
                }
            } catch (error) {
                console.error('åˆ·æ–°ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        async function refreshVideos() {
            try {
                const sortBy = document.getElementById('videoSort')?.value || 'time';
                const response = await fetch(`/api/videos?limit=0&dedup=1&sort_by=${sortBy}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const videosList = document.getElementById('videosList');
                    
                        if (data.data.length === 0) {
                            // ä¸è¦ç ´åè™šæ‹Ÿåˆ—è¡¨å†…å±‚ï¼›ä»…æ¸…ç©ºæ•°æ®å¹¶ç»˜åˆ¶ç©ºæ€
                            window.__videosList = [];
                            videosListVirtual.update();
                            if (!videosList.querySelector('.empty-state')) {
                                const empty = document.createElement('div');
                                empty.className = 'empty-state';
                                empty.innerHTML = '<div class="icon">ğŸ“¹</div><h3>æš‚æ— è§†é¢‘æ•°æ®</h3><p>è¯·å…ˆè¿è¡Œé˜¶æ®µä¸€è§†é¢‘é‡‡é›†åŠŸèƒ½</p>';
                                videosList.appendChild(empty);
                            }
                            return;
                        }

                    
                    //videosList.innerHTML = '';
                    window.__videosList = data.data;
                    const es = videosList.querySelector('.empty-state'); if (es) es.remove();
                    reconcileSelection('videos');
                    videosListVirtual.update();

                    // data.data.forEach(video => {
                    //     const videoItem = document.createElement('div');
                    //     videoItem.className = 'video-item';
                    //     const isSelected = selectedVideos.has(video.video_url);
                    //     if (isSelected) videoItem.classList.add('selected');
                        
                    //     videoItem.innerHTML = `
                    //         <div class="checkbox-container">
                    //             <input type="checkbox" class="video-select" data-key="${video.video_url}" ${isSelected ? 'checked' : ''}>
                    //         </div>
                    //         <div class="item-content">
                    //             <div class="video-header">
                    //                 <div class="video-title">${video.video_desc || 'æœªçŸ¥æè¿°'}</div>
                    //             </div>
                    //             <div class="video-meta">
                    //                 <span>ğŸ•’ ${video.publish_time|| 'æœªçŸ¥'}</span>
                    //                 <span>ğŸ¤– ${video.collected_time|| 'æœªçŸ¥'}</span>
                    //                 <span>ğŸ”‘ ${video.keyword || 'æœªçŸ¥'}</span>
                    //             </div>
                    //             <div class="video-meta">
                    //                 <span>
                    //                     ä½œè€…ï¼š
                    //                     ${
                    //                         video.author_url
                    //                             ? `<a href="${video.author_url}" target="_blank" style="color:#1890ff;text-decoration:none;">${video.author_name || 'æœªçŸ¥ä½œè€…'}</a>`
                    //                             : (video.author_name || 'æœªçŸ¥ä½œè€…')
                    //                     }
                    //                 </span>
                    //                 <span style="margin-left: 15px;">ğŸ‘ç‚¹èµï¼š${video.like_count || 0}</span>

                    //             </div>


                    //             <div class="video-desc">
                    //                 <a href="${video.video_url}" target="_blank" style="color: #1890ff; text-decoration: none;">ğŸ”— æŸ¥çœ‹è§†é¢‘</a>
                    //             </div>

                    //         </div>
                    //     `;
                    //     videosList.appendChild(videoItem);
                    // });
                                    // <span style="margin-left: 15px;">è¯„è®ºï¼š${video.comment_count || 0}</span> 
                                    // <span style="margin-left: 15px;">æ”¶è—ï¼š${video.collect_count || 0}</span>
                    // æ›´æ–°è§†é¢‘é€‰æ‹©ä¿¡æ¯
                    updateVideosSelectionInfo();
                }
            } catch (error) {
                console.error('åˆ·æ–°è§†é¢‘åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        async function refreshUsers() {
            try {
                const sortBy = document.getElementById('userSort')?.value || 'time';
                const response = await fetch(`/api/users?limit=0&dedup=1&sort_by=${sortBy}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const usersList = document.getElementById('usersList');
                    
                    if (data.data.length === 0) {
                        window.__usersList = [];
                        usersListVirtual.update();
                        if (!usersList.querySelector('.empty-state')) {
                            const empty = document.createElement('div');
                            empty.className = 'empty-state';
                            empty.innerHTML = '<div class="icon">ğŸ‘¥</div><h3>æš‚æ— ç”¨æˆ·æ•°æ®</h3><p>è¯·å…ˆè¿è¡Œé˜¶æ®µäºŒç”¨æˆ·é‡‡é›†åŠŸèƒ½</p>';
                            usersList.appendChild(empty);
                        }
                        return;
                    }
                    
                    //usersList.innerHTML = '';
                    window.__usersList = data.data;
                    const esu = usersList.querySelector('.empty-state'); if (esu) esu.remove();
                    reconcileSelection('users');
                    usersListVirtual.update();

                    // data.data.forEach(user => {
                    //     const userItem = document.createElement('div');
                    //     userItem.className = 'user-item';
                    //     const isSelected = selectedUsers.has(user.user_url);
                    //     if (isSelected) userItem.classList.add('selected');
                        
                    //     const statusClass = user.message_status === 'sent' ? 'status-sent' : 'status-pending';
                    //     const statusText = user.message_status === 'sent' ? 'å·²å‘é€' : 'å¾…å‘é€';
                        
                    //     const profileLink = user.user_url ? 
                    //         `<a href="${user.user_url}" target="_blank" rel="noopener" style="color: #1890ff; text-decoration: none; font-size: 0.8em;">ğŸ”— ä¸ªäººä¸»é¡µ</a>` : 
                    //         'ğŸ”— æ— ä¸»é¡µé“¾æ¥';
                        
                    //     userItem.innerHTML = `
                    //         <div class="checkbox-container">
                    //             <input type="checkbox" class="user-select" data-key="${user.user_url}" ${isSelected ? 'checked' : ''}>
                    //         </div>
                    //         <div class="item-content">
                    //             <div class="user-header">
                    //                 <div class="user-name">${user.username || 'æœªçŸ¥ç”¨æˆ·'}</div>
                    //                 <div class="status-badge ${statusClass}">${statusText}</div>
                    //             </div>
                    //             <div class="user-meta">
                    //                 <span>ğŸˆ ${user.ip_location || 'æœªçŸ¥'}</span>
                    //                 <span>ğŸ•’ ${user.comment_time || 'æœªçŸ¥'}</span>
                    //                 <span>ğŸ¤– ${user.collected_time|| 'æœªçŸ¥'}</span>
                    //                 <span>ğŸ”‘ ${user.matched_keyword || 'æœªçŸ¥'}</span>
                    //             </div>
                    //             <div style="margin: 6px 0;">
                    //                 ${profileLink}
                    //             </div>
                    //             <div class="user-comment">${user.comment_text || 'æ— è¯„è®ºå†…å®¹'}</div>
                    //         </div>
                    //     `;
                    //     usersList.appendChild(userItem);
                    // });
                    
                    // æ›´æ–°ç”¨æˆ·é€‰æ‹©ä¿¡æ¯
                    updateUsersSelectionInfo();
                }
            } catch (error) {
                console.error('åˆ·æ–°ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);
        function createVirtualList(containerId, rowHeight, getData, renderRow) {
            const container = document.getElementById(containerId);
            container.classList.add("virtual-list");

            const inner = document.createElement("div");
            inner.className = "virtual-list-inner";
            container.appendChild(inner);

            function update() {
                const list = getData(); // åŸæœ¬å°±æœ‰çš„æ•°æ®
                const total = list.length;

                inner.style.height = total * rowHeight + "px";

                const scrollTop = container.scrollTop;
                const viewHeight = container.clientHeight;

                const startIndex = Math.floor(scrollTop / rowHeight);
                const endIndex = Math.min(total - 1, Math.floor((scrollTop + viewHeight) / rowHeight));

                inner.innerHTML = ""; // æ¸…ç©ºï¼Œå¯è§åŒºé‡æ–°ç»˜åˆ¶

                for (let i = startIndex; i <= endIndex; i++) {
                    const row = document.createElement("div");
                    row.className = "virtual-row";
                    row.style.top = (i * rowHeight) + "px";
                    row.innerHTML = renderRow(list[i], i);

                    inner.appendChild(row);
                }
            }

            container.addEventListener("scroll", update);

            return { update };
        }
        const usersListVirtual = createVirtualList(
            "usersList", 
            150, // è¡Œé«˜åº¦ï¼ŒæŒ‰ä½ çš„å¸ƒå±€ç²¾ç¡®è®¾ç½®
            () => window.__usersList || [],
            (item, index) => generateUserHTML(item)
        );

        const videosListVirtual = createVirtualList(
            "videosList", 
            140,
            () => window.__videosList || [],
            (item, index) => generateVideoHTML(item)
        );
        function escapeHTML(s) {
        return String(s ?? '')
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#39;');
        }

        function generateVideoHTML(video) {
            // ç»Ÿä¸€ keyï¼ˆä½¿ç”¨è§†é¢‘é“¾æ¥åšå”¯ä¸€é”®ï¼Œå’Œä½ ç°æœ‰ selectedVideos é€»è¾‘ä¸€è‡´ï¼‰
            const key = String(video.id);

            // å…¼å®¹å‘å¸ƒæ—¶é—´/é‡‡é›†æ—¶é—´çš„ä¸åŒå‘½åï¼ˆpublish_time / publish_tsã€collected_time / collected_tsï¼‰
            const publishText =
                video.publish_time
                || (video.publish_ts ? new Date(Number(video.publish_ts) * 1000).toLocaleString() : 'æœªçŸ¥');

            const collectedText =
                video.collected_time
                || (video.collected_ts ? new Date(Number(video.collected_ts) * 1000).toLocaleString() : 'æœªçŸ¥');

            // å…¼å®¹ä½œè€…åç§°/ä¸»é¡µçš„ä¸åŒå‘½å
            const authorName = (
                video.author_name ??
                video.author ??
                video.nickname ??
                'æœªçŸ¥ä½œè€…'
            );

            const authorUrl = (
                video.author_url ??
                video.author_homepage ??
                ''
            );

            // å…¼å®¹ç‚¹èµå­—æ®µï¼šlike_count / digg_count / likes / like
            const likeCount = Number(
                video.like_count ??
                video.digg_count ??
                video.likes ??
                video.like ??
                0
            );

            const authorHtml = authorUrl
                ? `<a href="${authorUrl}" target="_blank" style="color:#1890ff;text-decoration:none;">${authorName}</a>`
                : authorName;

            const isChecked = selectedVideos.has(key);
            const selectedClass = isChecked ? ' selected' : '';

            return `
                <div class="video-item${selectedClass}">
                    <div class="checkbox-container">
                        <input type="checkbox" class="video-select" data-key="${key}" ${isChecked ? 'checked' : ''}>
                    </div>
                    <div class="item-content">
                        <div class="video-header">
                            <div class="video-title">${video.video_desc || 'æœªçŸ¥æè¿°'}</div>
                        </div>
                        <div class="video-meta">
                            <span>ğŸ•’ ${publishText || 'æœªçŸ¥'}</span>
                            <span>ğŸ¤– ${collectedText || 'æœªçŸ¥'}</span>
                            <span>ğŸ”‘ ${video.keyword || ''}</span>
                        </div>
                        <div class="video-meta">
                            <span>ä½œè€…ï¼š${authorHtml}</span>
                            <span style="margin-left: 15px;">ğŸ‘ç‚¹èµï¼š${likeCount}</span>
                        </div>
                        <div class="video-desc">
                            <a href="${video.video_url}" target="_blank" style="color:#1890ff;text-decoration:none;">ğŸ”— æŸ¥çœ‹è§†é¢‘</a>
                        </div>
                    </div>
                </div>
            `;
        }
        function generateUserHTML(user) {
            const isSelected = selectedUsers.has(String(user.id));
            const checked = isSelected ? "checked" : "";

            const statusClass = user.message_status === "sent" ? "status-sent" : "status-pending";
            const statusText  = user.message_status === "sent" ? "å·²å‘é€" : "å¾…å‘é€";

            const profileLink = user.user_url
                ? `<a href="${user.user_url}" target="_blank" rel="noopener" style="color:#1890ff;text-decoration:none;font-size:0.8em;">ğŸ”— ä¸ªäººä¸»é¡µ</a>`
                : "ğŸ”— æ— ä¸»é¡µé“¾æ¥";

            return `
                <div class="user-item ${isSelected ? "selected" : ""}">
                    <div class="checkbox-container">
                        <input type="checkbox" data-key="${user.id}" ${checked}>
                    </div>
                    <div class="item-content">
                        <div class="user-header">
                            <div class="user-name">${escapeHTML(user.username || "æœªçŸ¥ç”¨æˆ·")}</div>
                            <div class="status-badge ${statusClass}">${statusText}</div>
                        </div>

                        <div class="user-meta">
                            <span>ğŸˆ ${user.ip_location || "æœªçŸ¥"}</span>
                            <span>ğŸ•’ ${user.comment_time || "æœªçŸ¥"}</span>
                            <span>ğŸ¤– ${user.collected_time || "æœªçŸ¥"}</span>
                            <span>ğŸ”‘ ${user.matched_keyword || "æœªçŸ¥"}</span>
                        </div>

                        <div style="margin: 6px 0;">
                            ${profileLink}
                        </div>

                        <div class="user-comment">${escapeHTML(user.comment_text || "æ— è¯„è®ºå†…å®¹")}</div>
                    </div>
                </div>
            `;
        }


    </script>
</body>
</html>